# Session Summary — February 17, 2026

## Overview

This session focused on fixing critical bugs preventing the generation pipeline from working end-to-end, adding new AI providers and models, building the generation result display system, and cleaning up documentation.

---

## Issues Fixed

### 1. API Keys Not Saving to Database

**Root Cause**: `api-key-manager.ts` imported the browser Supabase singleton (`@/lib/db/client`) which has no auth session when called from server-side API routes. RLS blocked all operations.

**Fix**: Refactored all functions in `api-key-manager.ts` to accept a `SupabaseClient` parameter instead of importing a global client. Updated all callers (6 files) to pass the server-side Supabase client created with `@supabase/ssr` cookie-based auth.

**Files Changed**:
- `web/src/lib/crypto/api-key-manager.ts` — All functions now take `supabase: SupabaseClient` as first param
- `web/src/app/api/api-keys/route.ts` — Pass server client
- `web/src/app/api/api-keys/[id]/route.ts` — Pass server client
- `web/src/app/api/api-keys/test/route.ts` — Pass server client
- `web/src/app/api/providers/[provider]/models/route.ts` — Pass server client
- `web/src/app/api/estimate-cost/route.ts` — Pass server client

### 2. Generation Page "No Providers Configured"

**Root Cause**: `useAPIKeys` hook imported `getCurrentUser` from the old browser client which failed before the API call.

**Fix**: Removed the redundant client-side auth check since the API route handles auth via cookies.

**File Changed**: `web/src/hooks/use-api-keys.ts`

### 3. Provider Name Mismatch: "google" vs "gemini"

**Root Cause**: Settings page saves API keys with provider id `"google"` but `ProviderFactory` registers the provider as `"gemini"`.

**Fix**: Created a shared `provider-aliases.ts` module that maps `google` → `gemini`. Applied in all places that call `ProviderFactory.createProvider()`.

**Files Created/Changed**:
- `web/src/lib/ai/provider-aliases.ts` — New shared alias resolver
- `web/src/app/api/providers/[provider]/models/route.ts` — Resolve alias
- `web/src/app/api/estimate-cost/route.ts` — Resolve alias
- `web/src/lib/ai/provider-router.ts` — Resolve alias
- `web/src/app/api/generate/route.ts` — Resolve alias

### 4. RLS Policy Blocking Generation Insert

**Root Cause**: Same pattern as #1 — `generations.ts` queries used the browser Supabase singleton server-side.

**Fix**: Refactored all generation query functions to accept `SupabaseClient`. Updated all 3 API route callers.

**Files Changed**:
- `web/src/lib/db/queries/generations.ts` — All functions take `supabase` param
- `web/src/app/api/generate/route.ts` — Pass server client, simplified to use ProviderFactory directly
- `web/src/app/api/generations/route.ts` — Pass server client
- `web/src/app/api/generations/stats/route.ts` — Pass server client

### 5. Generation Results Not Displayed

**Root Cause**: No UI components existed to render generation output after completion.

**Fix**: Built complete result display system (see New Features below).

---

## New Features

### OpenRouter Provider

Added OpenRouter as a new provider supporting 400+ models via a single API key.

**File**: `web/src/lib/ai/providers/openrouter.ts`
- Text generation via `/chat/completions`
- Image generation via `/images/generations`
- Dynamic model fetching from `/models` endpoint with curated fallback list
- Registered in `provider-factory.ts` and added to Settings page

### Gemini Provider — Full Model Support

Upgraded from 3 hardcoded models to dynamic model fetching + image and video generation.

**File**: `web/src/lib/ai/providers/gemini.ts`

**Text Models**: All Gemini models (2.5 Pro, 2.5 Flash, 2.5 Flash-Lite, 2.0 Flash, 3.0 previews) fetched dynamically from `GET /v1beta/models?key=...`

**Image Generation** (3 methods):
- **Imagen 4** (`imagen-4.0-generate-001`, `ultra`, `fast`) — via `:predict` endpoint
- **Gemini Image** (`gemini-3-pro-image-preview`) — via `:generateContent` with `responseModalities: ["IMAGE", "TEXT"]`

**Video Generation**:
- **Veo** (`veo-3.1-generate-preview`, `veo-3.1-fast-generate-preview`, `veo-2.0-generate-001`) — via `:predictLongRunning` with polling

**Dynamic Model Discovery**: `getAvailableModels()` fetches all models with prefixes `gemini`, `imagen`, `veo` from the API. Falls back to a curated list of 15 models.

### Generation Result Display System

Built from scratch — previously no UI existed to show generation output.

**`web/src/components/generation/generation-result.tsx`** — Renders individual generation:
- **Text**: Scrollable content with copy-to-clipboard
- **Image**: Inline rendering with hover controls for fullscreen + download
- **Video**: `<video>` player for URL content
- **Audio**: `<audio>` player
- Processing spinner, error messages, metadata row (duration, tokens, cost)

**`web/src/components/generation/generation-history.tsx`** — Lists all generations for a project

**`web/src/app/(dashboard)/projects/[id]/generate/generate-client.tsx`** — Updated to:
- Show `GenerationHistory` below the form
- Poll every 2s after generation for status updates
- Added "← Back to Project" navigation link

**`web/src/app/(dashboard)/projects/[id]/page.tsx`** — Updated Assets tab to:
- Render actual generation results instead of placeholder
- Show loading state while fetching
- Empty state with "Generate Content" CTA button

---

## Architecture Patterns Established

### Server-Side Supabase Client Pattern

All API routes and server-side code must use the cookie-based server client from `@/lib/db/supabase-server`:

```typescript
import { getCurrentUser, createClient } from '@/lib/db/supabase-server'

const user = await getCurrentUser()      // Auth check
const supabase = await createClient()    // Client for DB queries
```

**Never** use `@/lib/db/client` (browser singleton) in API routes — it has no auth session and RLS will block everything.

### Provider Alias Pattern

Provider names in the database (from Settings page) may differ from factory-registered names. Always resolve via:

```typescript
import { resolveProviderName } from '@/lib/ai/provider-aliases'
const factoryName = resolveProviderName(dbProviderName) // "google" → "gemini"
```

Use the **raw** name for DB lookups (API keys stored as "google"), the **resolved** name for `ProviderFactory.createProvider()`.

### Generation Flow

```
Client → POST /api/generate → Create DB record → Return 202
                             → Fire-and-forget async execution:
                               1. Get server Supabase client
                               2. Decrypt API key (raw provider name)
                               3. Resolve provider alias
                               4. Create provider instance
                               5. Execute generation
                               6. Update DB record with result
```

---

## File Structure (Key Files)

```
web/src/
├── lib/
│   ├── ai/
│   │   ├── base-provider.ts          # Abstract provider class
│   │   ├── provider-factory.ts       # Registry of all providers
│   │   ├── provider-aliases.ts       # "google" → "gemini" mapping
│   │   ├── provider-router.ts        # Routing with fallback
│   │   └── providers/
│   │       ├── openai.ts
│   │       ├── anthropic.ts
│   │       ├── gemini.ts             # Text + Imagen + Veo
│   │       ├── openrouter.ts         # 400+ models
│   │       ├── fal.ts
│   │       ├── nano-banana.ts
│   │       └── veo3.ts
│   ├── crypto/
│   │   └── api-key-manager.ts        # Encrypt/decrypt/CRUD (takes SupabaseClient)
│   └── db/
│       ├── supabase-server.ts        # Server client (cookie-based auth)
│       ├── supabase-browser.ts       # Browser client (@supabase/ssr)
│       ├── client.ts                 # Legacy singleton (avoid in API routes)
│       └── queries/
│           └── generations.ts        # Generation CRUD (takes SupabaseClient)
├── components/generation/
│   ├── generation-form.tsx           # Provider/model select, prompt, submit
│   ├── generation-result.tsx         # Renders text/image/video/audio output
│   ├── generation-history.tsx        # Lists all generations for a project
│   └── parameter-controls.tsx        # Advanced settings (temp, tokens, etc.)
├── hooks/
│   ├── use-generations.ts            # React Query hooks for generations
│   └── use-api-keys.ts              # React Query hooks for API keys
└── app/
    ├── api/
    │   ├── generate/route.ts         # POST - create & execute generation
    │   ├── generations/route.ts      # GET - list generations
    │   ├── generations/stats/route.ts
    │   ├── api-keys/route.ts         # GET/POST API keys
    │   ├── api-keys/[id]/route.ts    # PUT/DELETE API keys
    │   ├── estimate-cost/route.ts
    │   └── providers/[provider]/models/route.ts
    └── (dashboard)/
        ├── settings/page.tsx         # API key management (5 providers)
        └── projects/[id]/
            ├── page.tsx              # Project home with Assets/Generate/Analytics tabs
            └── generate/
                ├── page.tsx          # Server component
                └── generate-client.tsx  # Client: type tabs, form, history, back nav
```

---

## Known Issues / Technical Debt

1. **`@/lib/db/client.ts`** (browser singleton) is still imported in some places — should be audited and replaced with proper server/browser clients
2. **`provider-selector.tsx`** is orphaned — no longer used by generation form (provider selection moved inline)
3. **`provider_configs` table** may not exist in all environments — `ProviderRouter` depends on it but `generate/route.ts` now bypasses it
4. **No Supabase Storage** for generated images — base64 data stored directly in `generations.result` column, which is inefficient for large images
5. **Video generation polling** happens synchronously in the API route — could timeout for long Veo generations

---

## Environment

- **Next.js**: 16.1.6 (Turbopack)
- **Node.js**: 18+
- **Supabase**: Cloud (uaduokvobvkbremkfhki)
- **Database**: PostgreSQL with RLS
- **Providers configured**: OpenRouter, Google (Gemini/Imagen/Veo)
